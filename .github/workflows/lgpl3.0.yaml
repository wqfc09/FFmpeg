name: FFmpeg-LGPL3

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          make
          pkg-config
          nasm
          yasm
          curl
          tar

    # 重点：手动克隆最新版 vcpkg，避免环境冲突和库缺失
    - name: Setup Fresh VCPKG
      shell: bash
      run: |
        git clone --depth 1 https://github.com/microsoft/vcpkg.git $GITHUB_WORKSPACE/vcpkg
        $GITHUB_WORKSPACE/vcpkg/bootstrap-vcpkg.bat
        # 设置环境变量，让后续步骤优先使用这个新 vcpkg
        echo "VCPKG_ROOT=$GITHUB_WORKSPACE/vcpkg" >> $GITHUB_ENV
        echo "$GITHUB_WORKSPACE/vcpkg" >> $GITHUB_PATH

    - name: Install vcpkg Dependencies
      # 修正了库名：libaom -> aom
      run: |
        vcpkg install libvpx:x64-windows-static
        vcpkg install dav1d:x64-windows-static
        vcpkg install aom:x64-windows-static
        vcpkg install onevpl:x64-windows-static
        vcpkg install opus:x64-windows-static
        vcpkg install zlib:x64-windows-static
        vcpkg install kvazaar:x64-windows-static

    - name: Install Hardware Headers
      shell: bash
      run: |
        mkdir -p /usr/local/include
        # NVIDIA NVENC 头文件
        curl -L https://github.com/FFmpeg/nv-codec-headers/archive/refs/heads/master.tar.gz -o nvenc.tar.gz
        tar -xzf nvenc.tar.gz
        cp -r nv-codec-headers-master/include/* /usr/local/include/
        # AMD AMF 头文件
        curl -L https://github.com/GPUOpen-Libraries-And-SDKs/AMF/archive/refs/heads/master.tar.gz -o amf.tar.gz
        tar -xzf amf.tar.gz
        mkdir -p /usr/local/include/AMF
        cp -r AMF-master/amf/public/include/* /usr/local/include/AMF/

    - name: Build FFmpeg
      shell: msys2 {0}
      run: |
        # 使用我们自己安装的 vcpkg 路径
        VCPKG_ROOT_MSYS="/c/users/runneradmin/work/${{ github.event.repository.name }}/${{ github.event.repository.name }}/vcpkg/installed/x64-windows-static"
        
        # 强制设置 pkg-config 寻找路径
        export PKG_CONFIG_PATH="$VCPKG_ROOT_MSYS/lib/pkgconfig"
        
        ./configure \
          --toolchain=msvc \
          --arch=x86_64 \
          --prefix=./publish \
          --enable-version3 \
          --disable-gpl \
          --disable-nonfree \
          --enable-static \
          --disable-shared \
          --pkg-config-flags="--static" \
          \
          --disable-all \
          --enable-ffmpeg --enable-ffprobe \
          --enable-avcodec --enable-avformat --enable-avfilter --enable-swresample --enable-swscale \
          \
          # 1. 容器与协议
          --enable-demuxer=mov,mp4,m4a,yuv4mpegpipe,h264,hevc \
          --enable-muxer=mp4,mov \
          --enable-protocol=file,http,https,tcp,udp \
          \
          # 2. 视频解码
          --enable-decoder=h264,hevc,vp9,av1 \
          --enable-parser=h264,hevc,vp9,av1 \
          --enable-libvpx --enable-libdav1d \
          \
          # 3. 视频编码 (硬件加速 + kvazaar)
          --enable-encoder=h264_nvenc,h264_amf,h264_qsv \
          --enable-encoder=hevc_nvenc,hevc_amf,hevc_qsv,libkvazaar \
          --enable-encoder=av1_nvenc,av1_amf,av1_qsv,libaom_av1 \
          --enable-encoder=libvpx_vp9 \
          \
          # 4. 音频支持
          --enable-encoder=aac,libopus --enable-decoder=aac,opus --enable-parser=aac,opus --enable-libopus \
          \
          # 5. 硬件加速接口
          --enable-nvenc --enable-nvdec --enable-amf --enable-qsv --enable-libvpl --enable-d3d11va --enable-dxva2 \
          \
          # 6. 滤镜与 BSF
          --enable-bsf=h264_mp4toannexb,hevc_mp4toannexb,av1_frame_merge \
          --enable-filter=aresample,scale,format,fps \
          \
          --extra-cflags="-I$VCPKG_ROOT_MSYS/include -I/usr/local/include" \
          --extra-ldflags="-LIBPATH:$VCPKG_ROOT_MSYS/lib -static"

        make -j$(nproc)
        make install

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-lgpl3-optimized
        path: publish/bin/*.exe
