name: FFmpeg-LGPL3-Ultimate-V6

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: make pkg-config nasm yasm curl tar

    # 核心修复：手动更新 vcpkg 索引并清除环境变量干扰
    - name: Update VCPKG Registry
      shell: bash
      run: |
        # 强制删除可能导致冲突的环境变量
        unset VCPKG_ROOT
        # 进入 vcpkg 预装目录并拉取最新 port 定义
        cd /c/vcpkg
        git pull
        ./bootstrap-vcpkg.bat

    - name: Install Dependencies
      shell: cmd
      run: |
        :: 显式指定路径，避免 mismatched 警告
        C:\vcpkg\vcpkg.exe install --triplet=x64-windows-static ^
          zlib libvpx dav1d aom onevpl opus kvazaar

    - name: Install Hardware Headers
      shell: bash
      run: |
        mkdir -p /usr/local/include
        # NVIDIA
        curl -L https://github.com/FFmpeg/nv-codec-headers/archive/refs/heads/master.tar.gz -o nvenc.tar.gz
        tar -xzf nvenc.tar.gz
        cp -r nv-codec-headers-master/include/* /usr/local/include/
        # AMD
        curl -L https://github.com/GPUOpen-Libraries-And-SDKs/AMF/archive/refs/heads/master.tar.gz -o amf.tar.gz
        tar -xzf amf.tar.gz
        mkdir -p /usr/local/include/AMF
        cp -r AMF-master/amf/public/include/* /usr/local/include/AMF/

    - name: Build FFmpeg
      shell: msys2 {0}
      run: |
        # 准确定位静态库安装后的路径
        VCPKG_STATIC_PATH="/c/vcpkg/installed/x64-windows-static"
        export PKG_CONFIG_PATH="${VCPKG_STATIC_PATH}/lib/pkgconfig"
        
        ./configure \
          --toolchain=msvc \
          --arch=x86_64 \
          --prefix=./publish \
          --enable-version3 --disable-gpl --disable-nonfree \
          --enable-static --disable-shared \
          --pkg-config-flags="--static" \
          --disable-all \
          --enable-ffmpeg --enable-ffprobe \
          --enable-avcodec --enable-avformat --enable-avfilter --enable-swresample --enable-swscale \
          --enable-demuxer=mov,mp4,m4a,yuv4mpegpipe,h264,hevc \
          --enable-muxer=mp4,mov \
          --enable-protocol=file,http,https,tcp,udp \
          --enable-decoder=h264,hevc,vp9,av1 \
          --enable-parser=h264,hevc,vp9,av1 \
          --enable-libvpx --enable-libdav1d \
          --enable-encoder=h264_nvenc,h264_amf,h264_qsv \
          --enable-encoder=hevc_nvenc,hevc_amf,hevc_qsv,libkvazaar \
          --enable-encoder=av1_nvenc,av1_amf,av1_qsv,libaom_av1 \
          --enable-encoder=libvpx_vp9 \
          --enable-encoder=aac,libopus --enable-decoder=aac,opus --enable-parser=aac,opus --enable-libopus \
          --enable-nvenc --enable-nvdec --enable-amf --enable-qsv --enable-libvpl --enable-d3d11va --enable-dxva2 \
          --enable-bsf=h264_mp4toannexb,hevc_mp4toannexb,av1_frame_merge \
          --enable-filter=aresample,scale,format,fps \
          --extra-cflags="-I${VCPKG_STATIC_PATH}/include -I/usr/local/include" \
          --extra-ldflags="-LIBPATH:${VCPKG_STATIC_PATH}/lib -static"

        make -j$(nproc)
        make install

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-lgpl3-fixed
        path: publish/bin/*.exe
