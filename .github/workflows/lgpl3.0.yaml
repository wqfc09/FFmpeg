name: FFmpeg-LGPL3

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          make
          pkg-config
          nasm
          yasm
          curl
          tar

    - name: Install vcpkg Dependencies
      # 安装核心依赖库（静态链接版）
      run: |
        vcpkg install libvpx:x64-windows-static
        vcpkg install dav1d:x64-windows-static
        vcpkg install libaom:x64-windows-static
        vcpkg install onevpl:x64-windows-static
        vcpkg install opus:x64-windows-static
        vcpkg install zlib:x64-windows-static
        vcpkg install kvazaar:x64-windows-static

    - name: Install Hardware Headers (Fixed)
      shell: bash
      run: |
        mkdir -p /usr/local/include
        
        # 使用 curl 直接下载源码包，避开 git 验证报错
        # 1. NVIDIA NVENC 头文件
        echo "Downloading NVENC headers..."
        curl -L https://github.com/FFmpeg/nv-codec-headers/archive/refs/heads/master.tar.gz -o nvenc.tar.gz
        tar -xzf nvenc.tar.gz
        cp -r nv-codec-headers-master/include/* /usr/local/include/
        
        # 2. AMD AMF 头文件
        echo "Downloading AMF headers..."
        curl -L https://github.com/GPUOpen-Libraries-And-SDKs/AMF/archive/refs/heads/master.tar.gz -o amf.tar.gz
        tar -xzf amf.tar.gz
        mkdir -p /usr/local/include/AMF
        cp -r AMF-master/amf/public/include/* /usr/local/include/AMF/
        
        echo "Hardware headers installed to /usr/local/include"

    - name: Build FFmpeg
      shell: msys2 {0}
      run: |
        # 转换 vcpkg 路径
        VCPKG_ROOT="/c/vcpkg/installed/x64-windows-static"
        export PKG_CONFIG_PATH="$VCPKG_ROOT/lib/pkgconfig"
        
        ./configure \
          --toolchain=msvc \
          --arch=x86_64 \
          --prefix=./publish \
          \
          --enable-version3 \
          --disable-gpl \
          --disable-nonfree \
          \
          --enable-static \
          --disable-shared \
          --pkg-config-flags="--static" \
          \
          # 精简模式：白名单开启
          --disable-all \
          --enable-ffmpeg --enable-ffprobe \
          --enable-avcodec --enable-avformat --enable-avfilter --enable-swresample --enable-swscale \
          \
          # 1. 容器与协议 (MP4/MOV)
          --enable-demuxer=mov,mp4,m4a,yuv4mpegpipe,h264,hevc \
          --enable-muxer=mp4,mov \
          --enable-protocol=file,http,https,tcp,udp \
          \
          # 2. 视频解码 (包含 H.264)
          --enable-decoder=h264,hevc,vp9,av1 \
          --enable-parser=h264,hevc,vp9,av1 \
          --enable-libvpx --enable-libdav1d \
          \
          # 3. 视频编码 (硬件加速 + kvazaar)
          --enable-encoder=h264_nvenc,h264_amf,h264_qsv \
          --enable-encoder=hevc_nvenc,hevc_amf,hevc_qsv,libkvazaar \
          --enable-encoder=av1_nvenc,av1_amf,av1_qsv,libaom_av1 \
          --enable-encoder=libvpx_vp9 \
          \
          # 4. 音频支持 (AAC + Opus)
          --enable-encoder=aac,libopus \
          --enable-decoder=aac,opus \
          --enable-parser=aac,opus \
          --enable-libopus \
          \
          # 5. 硬件加速接口
          --enable-nvenc --enable-nvdec --enable-amf --enable-qsv --enable-libvpl --enable-d3d11va --enable-dxva2 \
          \
          # 6. 滤镜与比特流过滤器 (MP4 封装必需)
          --enable-bsf=h264_mp4toannexb,hevc_mp4toannexb,av1_frame_merge \
          --enable-filter=aresample,scale,format,fps \
          \
          --extra-cflags="-I$VCPKG_ROOT/include -I/usr/local/include" \
          --extra-ldflags="-LIBPATH:$VCPKG_ROOT/lib -static"

        make -j$(nproc)
        make install

    - name: Verify Build
      shell: cmd
      run: |
        if exist publish\bin\ffmpeg.exe (
          publish\bin\ffmpeg.exe -version
          publish\bin\ffmpeg.exe -encoders | findstr "kvazaar nvenc amf qsv libaom"
        ) else (
          echo "Build failed: ffmpeg.exe not found."
          exit 1
        )

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-lgpl3-ultimate-binary
        path: publish/bin/*.exe
