name: FFmpeg-Linux-LGPL3

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential pkg-config nasm yasm cmake \
          git curl libvpx-dev libdav1d-dev libaom-dev libopus-dev zlib1g-dev

    # 1. 手动编译 libvpl (Intel QSV)
    - name: Build libvpl
      run: |
        git clone --depth 1 https://github.com/intel/libvpl
        cd libvpl
        cmake -B build -DBUILD_SHARED_LIBS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTS=OFF \
              -DCMAKE_INSTALL_PREFIX=$HOME/ffmpeg_build
        cmake --build build --parallel $(nproc)
        cmake --install build

    # 2. 手动编译 kvazaar (H.265 CPU)
    - name: Build kvazaar
      run: |
        git clone --depth 1 https://github.com/ultravideo/kvazaar
        cd kvazaar
        cmake -B build -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=$HOME/ffmpeg_build
        cmake --build build --parallel $(nproc)
        cmake --install build

    # 3. 安装硬件加速头文件 (NVIDIA & AMD)
    - name: Install Hardware Headers
      run: |
        # NVIDIA
        git clone --depth 1 https://github.com/FFmpeg/nv-codec-headers
        cd nv-codec-headers && sudo make install PREFIX=$HOME/ffmpeg_build && cd ..
        
        # AMD AMF
        git clone --depth 1 https://github.com/GPUOpen-Libraries-And-SDKs/AMF
        mkdir -p $HOME/ffmpeg_build/include/AMF
        cp -r AMF/amf/public/include/* $HOME/ffmpeg_build/include/AMF/

    # 4. 最终构建 FFmpeg 静态二进制文件
    - name: Build FFmpeg Static
      run: |
        export PKG_CONFIG_PATH=$HOME/ffmpeg_build/lib/pkgconfig:$HOME/ffmpeg_build/lib64/pkgconfig:/usr/lib/pkgconfig
        
        ./configure \
          --prefix=$HOME/ffmpeg_build/publish \
          --enable-version3 --disable-gpl --disable-nonfree \
          --enable-static --disable-shared \
          \
          --disable-all \
          --enable-ffmpeg --enable-ffprobe \
          --enable-avcodec --enable-avformat --enable-avfilter --enable-swresample --enable-swscale \
          \
          # 1. 容器与协议
          --enable-demuxer=mov,mp4,m4a,yuv4mpegpipe,h264,hevc \
          --enable-muxer=mp4,mov \
          --enable-protocol=file,http,https,tcp,udp \
          \
          # 2. 解码与解析
          --enable-decoder=h264,hevc,vp9,av1,aac,opus \
          --enable-parser=h264,hevc,vp9,av1,aac,opus \
          --enable-libvpx --enable-libdav1d \
          \
          # 3. 编码器 (精准命名：libvpl, libkvazaar)
          --enable-libvpl \
          --enable-libkvazaar \
          --enable-libaom \
          --enable-libopus \
          --enable-encoder=h264_nvenc,h264_vaapi \
          --enable-encoder=hevc_nvenc,hevc_vaapi,libkvazaar \
          --enable-encoder=av1_nvenc,libaom_av1 \
          --enable-encoder=libvpx_vp9,aac,libopus \
          \
          # 4. 硬件加速接口 (Linux 主要是 VAAPI 和 NVENC)
          --enable-nvenc --enable-nvdec \
          --enable-vaapi \
          \
          # 5. 必要的过滤器
          --enable-bsf=h264_mp4toannexb,hevc_mp4toannexb,av1_frame_merge \
          --enable-filter=aresample,scale,format,fps \
          \
          --extra-cflags="-I$HOME/ffmpeg_build/include" \
          --extra-ldflags="-L$HOME/ffmpeg_build/lib -L$HOME/ffmpeg_build/lib64 -static" \
          --pkg-config-flags="--static"

        make -j$(nproc)
        make install

    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-linux-static-lgpl3
        path: $HOME/ffmpeg_build/publish/bin/ffmpeg
