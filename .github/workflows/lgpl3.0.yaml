name: FFmpeg-Linux-LGPL

on:
  workflow_dispatch:

jobs:
  build:
    # 必须使用 24.04 才能在 apt 中获得 dav1d >= 1.0.0
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout FFmpeg
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install Build Essentials
      run: |
        sudo apt-get update
        # 直接安装系统自带的最新版 dav1d 及其他开发库 
        sudo apt-get install -y build-essential pkg-config nasm yasm cmake \
          curl tar git libvpx-dev libaom-dev libopus-dev zlib1g-dev \
          libdav1d-dev  # 这里直接使用系统库

    # 1. 手动编译 libvpl (Intel QSV 核心)
    - name: Build libvpl
      run: |
        curl -L https://github.com/intel/libvpl/archive/refs/heads/main.tar.gz -o vpl.tar.gz
        tar -xzf vpl.tar.gz
        cd libvpl-main
        cmake -B build -DBUILD_SHARED_LIBS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTS=OFF \
              -DCMAKE_INSTALL_PREFIX=$HOME/custom_build
        cmake --build build --parallel $(nproc)
        cmake --install build

    # 2. 手动编译 kvazaar (H.265 CPU 编码)
    - name: Build kvazaar
      run: |
        # 使用 git 获取 v2.3.2 标签，这样 .pc 文件里才会有版本号
        git clone --branch v2.3.2 --depth 1 https://github.com/ultravideo/kvazaar
        # 核心修复：手动向 CMake 注入版本号，防止 .pc 文件显示 unknown
        cmake -B kvz_build -S kvazaar \
              -DBUILD_SHARED_LIBS=OFF \
              -DCMAKE_INSTALL_PREFIX=$HOME/custom_build \
              -DPROJECT_VERSION="2.3.2"
        cmake --build kvz_build --parallel $(nproc)
        cmake --install kvz_build
        
        # 强制修改 .pc 文件中的版本号，确保 FFmpeg 能够通过 >= 2.0.0 的检测
        sed -i 's/Version: .*/Version: 2.3.2/' $HOME/custom_build/lib/pkgconfig/kvazaar.pc
        # 打印一下确认修改成功
        cat $HOME/custom_build/lib/pkgconfig/kvazaar.pc

    # 3. 安装硬件加速头文件
    - name: Install Hardware Headers
      run: |
        mkdir -p $HOME/custom_build/include
        # NVIDIA
        curl -L https://github.com/FFmpeg/nv-codec-headers/archive/refs/heads/master.tar.gz -o nvenc.tar.gz
        tar -xzf nvenc.tar.gz
        cd nv-codec-headers-master && make PREFIX=$HOME/custom_build install && cd ..
        # AMD AMF
        curl -L https://github.com/GPUOpen-LibrariesAndSDKs/AMF/archive/refs/heads/master.tar.gz -o amf.tar.gz
        tar -xzf amf.tar.gz
        mkdir -p $HOME/custom_build/include/AMF
        cp -r AMF-master/amf/public/include/* $HOME/custom_build/include/AMF/

    # 4. 构建 FFmpeg 静态二进制文件
# 4. 构建 FFmpeg (混合链接模式)
    - name: Build FFmpeg
      run: |
        export PKG_CONFIG_PATH=$HOME/custom_build/lib/pkgconfig:$HOME/custom_build/lib64/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig
        
        ./configure \
          --prefix=$HOME/custom_build/publish \
          --enable-version3 \
          --disable-gpl \
          --disable-nonfree \
          --enable-static \
          --disable-shared \
          --disable-all \
          --enable-ffmpeg \
          --enable-ffprobe \
          --enable-avcodec \
          --enable-avformat \
          --enable-avfilter \
          --enable-swresample \
          --enable-swscale \
          --enable-demuxer=mov,mp4,m4a,yuv4mpegpipe,h264,hevc \
          --enable-muxer=mp4,mov \
          --enable-protocol=file,http,https,tcp,udp \
          --enable-decoder=h264,hevc,vp9,av1,aac,opus \
          --enable-parser=h264,hevc,vp9,av1,aac,opus \
          --enable-libvpx \
          --enable-libdav1d \
          --enable-libvpl \
          --enable-libkvazaar \
          --enable-libaom \
          --enable-libopus \
          --enable-encoder=h264_nvenc,h264_vaapi,hevc_nvenc,hevc_qsv,hevc_vaapi,libkvazaar,av1_nvenc,av1_qsv,libaom_av1,libvpx_vp9,aac,libopus \
          --enable-nvenc \
          --enable-nvdec \
          --enable-vaapi \
          --enable-amf \
          --enable-bsf=h264_mp4toannexb,hevc_mp4toannexb,av1_frame_merge \
          --enable-filter=aresample,scale,format,fps \
          --extra-cflags="-I$HOME/custom_build/include" \
          --extra-ldflags="-L$HOME/custom_build/lib -L$HOME/custom_build/lib64"

        make -j$(nproc)
        make install

    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-lgpl3-linux-fastbuild
        # 确保路径能兼容各种 Runner 环境
        path: |
          ${{ github.workspace }}/../custom_build/publish/bin/ffmpeg
          ${{ github.workspace }}/custom_build/publish/bin/ffmpeg
