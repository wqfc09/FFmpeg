name: FFmpeg-LGPL3-Native-Final

on:
  workflow_dispatch:

jobs:
  # =========================================================================
  # üêß JOB 1: Linux (Ubuntu) - ÂÖ®ÂäüËÉΩÊûÑÂª∫
  # =========================================================================
  build-linux:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # Ë°•ÈΩê‰∫Ü libzimg-dev (È´òÊÄßËÉΩËâ≤ÂΩ©ËΩ¨Êç¢)
        sudo apt-get install -y build-essential pkg-config nasm yasm cmake curl git meson ninja-build \
                                libssl-dev libvpx-dev libopus-dev libdav1d-dev libva-dev libdrm-dev libzimg-dev \
                                rustc cargo clang

    # 1. ÁºñËØë libquiche (QUIC)
    - name: Build libquiche (Linux)
      run: |
        git clone --depth 1 --recursive https://github.com/cloudflare/quiche
        cd quiche
        cargo build --package quiche --release --features ffi,pkg-config-meta
        mkdir -p $HOME/target_build/include $HOME/target_build/lib/pkgconfig
        cp include/quiche.h $HOME/target_build/include/
        cp target/release/libquiche.a $HOME/target_build/lib/
        cp target/release/quiche.pc $HOME/target_build/lib/pkgconfig/

    # 2. ÁºñËØë libvpl (Intel QSV)
    - name: Build libvpl
      run: |
        git clone --branch main --depth 1 https://github.com/oneapi-src/oneVPL libvpl
        cmake -B vpl_build -S libvpl -DCMAKE_INSTALL_PREFIX=$HOME/target_build -DBUILD_SHARED_LIBS=OFF -DBUILD_EXAMPLES=OFF -DBUILD_TESTS=OFF
        cmake --build vpl_build --parallel $(nproc)
        cmake --install vpl_build
        sed -i 's/Libs: .*/& -lstdc++ -ldl -lpthread/' $HOME/target_build/lib/pkgconfig/vpl.pc

    # 3. ÁºñËØë kvazaar (HEVC ËΩØÁºñ)
    - name: Build kvazaar
      run: |
        git clone --branch v2.3.2 --depth 1 https://github.com/ultravideo/kvazaar
        sed -i '1i cmake_minimum_required(VERSION 3.10)\ncmake_policy(SET CMP0057 NEW)' kvazaar/CMakeLists.txt
        cmake -B kvz_build -S kvazaar -DCMAKE_INSTALL_PREFIX=$HOME/target_build -DBUILD_SHARED_LIBS=OFF -Dkvazaar_tests=OFF
        cmake --build kvz_build --parallel $(nproc)
        cmake --install kvz_build
        sed -i 's/Libs.private:.*/Libs.private: -lpthread -lm -ldl -lrt/' $HOME/target_build/lib/pkgconfig/kvazaar.pc

    # 4. ÁºñËØë FFmpeg
    - name: Build FFmpeg
      run: |
        export PKG_CONFIG_PATH=$HOME/target_build/lib/pkgconfig:$PKG_CONFIG_PATH
        
        # ‰øÆÊ≠£ÔºöÊ∑ªÂä†‰∫Ü --enable-libzimg, --enable-libopus
        ./configure \
          --prefix=$HOME/publish/linux \
          --enable-version3 --disable-gpl --disable-nonfree \
          --enable-static --disable-shared --disable-all \
          --enable-ffmpeg --enable-ffprobe \
          --enable-avcodec --enable-avformat --enable-avfilter --enable-avdevice --enable-swresample --enable-swscale \
          --enable-libvpl --enable-libkvazaar --enable-libquiche --enable-openssl --enable-libzimg \
          --enable-network --enable-protocol=file,http,https,tcp,udp,tls,quic \
          --enable-hwaccel=h264_qsv,hevc_qsv,vp9_qsv,av1_qsv \
          --enable-vaapi --enable-libdav1d --enable-libvpx --enable-libopus \
          --enable-decoder=h264,hevc,vp9,av1,wrapped_avframe,libdav1d \
          --enable-encoder=h264_vaapi,hevc_vaapi,h264_qsv,hevc_qsv,libkvazaar,libopus,wrapped_avframe \
          --enable-demuxer=lavfi,avi,mov,mp4,flv,h264,hevc \
          --enable-muxer=mp4,mov,null,image2 \
          --enable-filter=split,scale,format,buffer,buffersink,null,testsrc2,zimg \
          --extra-cflags="-I$HOME/target_build/include" \
          --extra-ldflags="-L$HOME/target_build/lib -lstdc++ -lpthread -lm -ldl -lrt"
        
        make -j$(nproc) && make install

    - name: Upload Linux Binary
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-linux
        path: ~/publish/linux/bin/ffmpeg*

  # =========================================================================
  # ü™ü JOB 2: Windows (MSYS2) - ÂÖ®ÂäüËÉΩË°•ÂÖ®Áâà
  # =========================================================================
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        install: >-
          base-devel
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-nasm
          mingw-w64-x86_64-rust
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-dav1d
          mingw-w64-x86_64-opus
          mingw-w64-x86_64-lame
          mingw-w64-x86_64-zimg
          git

    - name: Build Dependencies & FFmpeg (Windows)
      shell: msys2 {0}
      run: |
        TARGET_DIR=$(pwd)/target_build
        mkdir -p $TARGET_DIR
        export PATH=$TARGET_DIR/bin:$PATH
        export PKG_CONFIG_PATH=$TARGET_DIR/lib/pkgconfig:/mingw64/lib/pkgconfig

        # --- A. ÁºñËØë libquiche (Rust) ---
        echo "Building libquiche..."
        git clone --depth 1 --recursive https://github.com/cloudflare/quiche
        cd quiche
        cargo build --package quiche --release --features ffi,pkg-config-meta
        
        mkdir -p $TARGET_DIR/include $TARGET_DIR/lib/pkgconfig
        cp include/quiche.h $TARGET_DIR/include/
        cp target/release/libquiche.a $TARGET_DIR/lib/
        cp target/release/quiche.pc $TARGET_DIR/lib/pkgconfig/
        cd ..

        # --- B. ÁºñËØë kvazaar ---
        echo "Building kvazaar..."
        git clone --branch v2.3.2 --depth 1 https://github.com/ultravideo/kvazaar
        cmake -B kvz_build -S kvazaar -G "Unix Makefiles" \
              -DCMAKE_INSTALL_PREFIX=$TARGET_DIR -DBUILD_SHARED_LIBS=OFF -Dkvazaar_tests=OFF
        cmake --build kvz_build --parallel $(nproc)
        cmake --install kvz_build
        sed -i 's/Libs.private:.*/Libs.private: -lpthread/' $TARGET_DIR/lib/pkgconfig/kvazaar.pc
        sed -i 's/^Cflags:.*/& -DKVZ_STATIC_LIB/' $TARGET_DIR/lib/pkgconfig/kvazaar.pc

        # --- C. ÂÆâË£Ö NVENC Â§¥Êñá‰ª∂ ---
        echo "Installing NVENC headers..."
        git clone --depth 1 https://github.com/FFmpeg/nv-codec-headers
        cd nv-codec-headers
        make PREFIX=$TARGET_DIR install
        cd ..

        # --- D. ÁºñËØë FFmpeg ---
        echo "Configuring FFmpeg..."
        
        # ‰øÆÊ≠£Ôºö
        # 1. ÂºÄÂêØ‰∫Ü libdav1d (AV1 Ëß£Á†Å)
        # 2. ÂºÄÂêØ‰∫Ü libopus (Èü≥È¢ë)
        # 3. ÂºÄÂêØ‰∫Ü libzimg (Êª§Èïú)
        # 4. ÂºÄÂêØ‰∫Ü libmp3lame (MP3 ÁºñÁ†Å)
        
        ./configure \
          --prefix=$(pwd)/publish \
          --arch=x86_64 --target-os=mingw32 \
          --pkg-config=pkg-config --pkg-config-flags="--static" \
          --enable-version3 --disable-gpl --disable-nonfree \
          --enable-static --disable-shared --disable-all \
          --enable-ffmpeg --enable-ffprobe \
          --enable-avcodec --enable-avformat --enable-avfilter --enable-avdevice --enable-swresample --enable-swscale \
          --enable-libkvazaar --enable-libquiche --enable-openssl --enable-libzimg \
          --enable-libdav1d --enable-libopus --enable-libmp3lame \
          --enable-network --enable-protocol=file,http,https,tcp,udp,tls,quic \
          --enable-hwaccel=h264_qsv,hevc_qsv,cuda,d3d11va,dxva2 \
          --enable-decoder=h264,hevc,vp9,av1,libdav1d,h264_qsv,hevc_qsv,h264_cuvid,hevc_cuvid,wrapped_avframe \
          --enable-encoder=h264_nvenc,hevc_nvenc,h264_qsv,hevc_qsv,libkvazaar,libopus,libmp3lame,wrapped_avframe \
          --enable-demuxer=lavfi,avi,mov,mp4,flv,h264,hevc \
          --enable-muxer=mp4,mov,null,image2 \
          --enable-filter=split,scale,format,buffer,buffersink,scale_cuda,testsrc2,zimg \
          --extra-cflags="-I$TARGET_DIR/include -DKVZ_STATIC_LIB" \
          --extra-ldflags="-L$TARGET_DIR/lib -static -lstdc++ -lpthread -lws2_32 -lbcrypt -lcrypt32 -lole32 -luserenv"

        echo "Compiling FFmpeg..."
        make -j$(nproc)
        make install

    - name: Upload Windows Binary
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows
        path: publish/bin/ffmpeg.exe
